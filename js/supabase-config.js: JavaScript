// Initialize Supabase client
const SUPABASE_URL = 'https://tqcazpmpepyavpklskop.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRxY2F6cG1wZXB5YXZwa2xza29wIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxODQxMzEsImV4cCI6MjA3ODc2MDEzMX0.LWAUPB215tzvfeLvaO_VT7ba2vstXy0L2f28CQkM3lI';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Blog Management Class
class BlogManager {
    constructor() {
        this.supabase = supabase;
    }

    // Fetch all published blog posts
    async getPublishedPosts(limit = null) {
        try {
            let query = this.supabase
                .from('blog_posts')
                .select('*')
                .eq('status', 'published')
                .order('published_at', { ascending: false });
            
            if (limit) {
                query = query.limit(limit);
            }

            const { data, error } = await query;
            
            if (error) throw error;
            return data || [];
        } catch (error) {
            console.error('Error fetching posts:', error);
            return [];
        }
    }

    // Get all posts (for admin)
    async getAllPosts() {
        try {
            const { data, error } = await this.supabase
                .from('blog_posts')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) throw error;
            return data || [];
        } catch (error) {
            console.error('Error fetching all posts:', error);
            return [];
        }
    }

    // Get single post by slug
    async getPostBySlug(slug) {
        try {
            const { data, error } = await this.supabase
                .from('blog_posts')
                .select('*')
                .eq('slug', slug)
                .eq('status', 'published')
                .single();
            
            if (error) throw error;
            return data;
        } catch (error) {
            console.error('Error fetching post:', error);
            return null;
        }
    }

    // Get posts by category
    async getPostsByCategory(category) {
        try {
            const { data, error } = await this.supabase
                .from('blog_posts')
                .select('*')
                .eq('category', category)
                .eq('status', 'published')
                .order('published_at', { ascending: false });
            
            if (error) throw error;
            return data || [];
        } catch (error) {
            console.error('Error fetching posts by category:', error);
            return [];
        }
    }

    // Search posts
    async searchPosts(searchTerm) {
        try {
            const { data, error } = await this.supabase
                .from('blog_posts')
                .select('*')
                .eq('status', 'published')
                .or(`title.ilike.%${searchTerm}%,excerpt.ilike.%${searchTerm}%,content.ilike.%${searchTerm}%`)
                .order('published_at', { ascending: false });
            
            if (error) throw error;
            return data || [];
        } catch (error) {
            console.error('Error searching posts:', error);
            return [];
        }
    }

    // Admin functions
    async createPost(post) {
        try {
            const { data, error } = await this.supabase
                .from('blog_posts')
                .insert([{
                    ...post,
                    published_at: post.status === 'published' ? new Date().toISOString() : null,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                }])
                .select();
            
            if (error) throw error;
            return data[0];
        } catch (error) {
            console.error('Error creating post:', error);
            throw error;
        }
    }

    async updatePost(id, updates) {
        try {
            const { data, error } = await this.supabase
                .from('blog_posts')
                .update({ 
                    ...updates, 
                    updated_at: new Date().toISOString(),
                    published_at: updates.status === 'published' ? new Date().toISOString() : null
                })
                .eq('id', id)
                .select();
            
            if (error) throw error;
            return data[0];
        } catch (error) {
            console.error('Error updating post:', error);
            throw error;
        }
    }

    async deletePost(id) {
        try {
            const { error } = await this.supabase
                .from('blog_posts')
                .delete()
                .eq('id', id);
            
            if (error) throw error;
            return true;
        } catch (error) {
            console.error('Error deleting post:', error);
            throw error;
        }
    }

    // Create slug from title
    createSlug(title) {
        return title
            .toLowerCase()
            .replace(/[^\w ]+/g, '')
            .replace(/ +/g, '-');
    }
}

// Initialize blog manager
const blogManager = new BlogManager();
