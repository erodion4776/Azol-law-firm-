<!-- Replace the existing script section in checkout.html with this updated version -->

<script>
    // Initialize Stripe (Replace with your publishable key)
    // const stripe = Stripe('pk_test_YOUR_PUBLISHABLE_KEY_HERE');
    // const elements = stripe.elements();

    // Get cart data from sessionStorage
    let cartItems = JSON.parse(sessionStorage.getItem('cartItems')) || [];
    
    // Initialize checkout page
    function initCheckout() {
        if (cartItems.length === 0) {
            // Redirect to cart if no items
            window.location.href = 'cart.html';
            return;
        }
        
        displayCartItems();
        updateTotals();
        attachEventListeners();
    }

    // Display cart items in order summary
    function displayCartItems() {
        const cartItemsContainer = document.getElementById('cartItems');
        cartItemsContainer.innerHTML = '';
        
        cartItems.forEach(item => {
            const cartItemHTML = `
                <div class="cart-item" data-item-id="${item.id}">
                    <div class="item-details">
                        <div class="item-name">${item.name}</div>
                        <div class="item-type">Quantity: ${item.quantity}</div>
                    </div>
                    <div class="item-price">$${(item.price * item.quantity).toFixed(2)}</div>
                    <i class="fas fa-times remove-item" data-item-id="${item.id}"></i>
                </div>
            `;
            cartItemsContainer.insertAdjacentHTML('beforeend', cartItemHTML);
        });
        
        // Reattach remove listeners
        document.querySelectorAll('.remove-item').forEach(btn => {
            btn.addEventListener('click', handleRemoveItem);
        });
    }

    // Update totals based on cart items
    function updateTotals() {
        const subtotal = cartItems.reduce((total, item) => total + (item.price * item.quantity), 0);
        const discountAmount = getDiscountAmount(subtotal);
        const taxableAmount = subtotal - discountAmount;
        const tax = taxableAmount * 0.09; // 9% tax rate
        const total = taxableAmount + tax;
        
        // Update display
        document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('tax').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        
        // Show discount if applied
        if (discountAmount > 0) {
            document.getElementById('discountRow').style.display = 'flex';
            document.getElementById('discount').textContent = `-$${discountAmount.toFixed(2)}`;
        }
    }

    // Get discount amount (check if promo was applied in cart)
    function getDiscountAmount(subtotal) {
        const appliedPromo = sessionStorage.getItem('appliedPromo');
        if (appliedPromo === 'SAVE10' || appliedPromo === 'LEGAL10') {
            return subtotal * 0.1; // 10% discount
        }
        return 0;
    }

    // Handle remove item from checkout
    function handleRemoveItem(e) {
        const itemId = parseInt(e.currentTarget.dataset.itemId);
        
        // Remove from array
        cartItems = cartItems.filter(item => item.id !== itemId);
        
        // Update sessionStorage
        sessionStorage.setItem('cartItems', JSON.stringify(cartItems));
        
        if (cartItems.length === 0) {
            // Redirect to shop if cart becomes empty
            alert('Your cart is empty. Redirecting to shop...');
            window.location.href = 'shop.html';
        } else {
            // Refresh display
            displayCartItems();
            updateTotals();
        }
    }

    // Payment method selection
    const paymentMethods = document.querySelectorAll('.payment-method');
    const cardPayment = document.getElementById('card-payment');
    const paypalPayment = document.getElementById('paypal-payment');

    function attachEventListeners() {
        // Payment method selection
        paymentMethods.forEach(method => {
            method.addEventListener('click', () => {
                paymentMethods.forEach(m => m.classList.remove('selected'));
                method.classList.add('selected');
                
                if (method.dataset.method === 'card') {
                    cardPayment.style.display = 'block';
                    paypalPayment.style.display = 'none';
                } else {
                    cardPayment.style.display = 'none';
                    paypalPayment.style.display = 'block';
                }
            });
        });

        // Apply promo code
        document.querySelector('.btn-apply').addEventListener('click', handlePromoCode);

        // Form submission
        document.getElementById('submitPayment').addEventListener('click', handleSubmitPayment);
    }

    // Handle promo code application
    function handlePromoCode() {
        const promoCode = document.getElementById('promoCode').value.trim().toUpperCase();
        
        if (promoCode === 'SAVE10' || promoCode === 'LEGAL10') {
            sessionStorage.setItem('appliedPromo', promoCode);
            updateTotals();
            
            // Show success message
            const promoInput = document.getElementById('promoCode');
            promoInput.style.borderColor = 'var(--success-color)';
            promoInput.disabled = true;
            document.querySelector('.btn-apply').textContent = 'Applied!';
            document.querySelector('.btn-apply').style.background = 'var(--success-color)';
        } else {
            alert('Invalid promo code');
        }
    }

    // Form validation
    const form = document.getElementById('checkoutForm');

    function validateForm() {
        const inputs = form.querySelectorAll('input[required], select[required]');
        let isValid = true;

        inputs.forEach(input => {
            if (!input.value) {
                input.classList.add('input-error');
                if (input.nextElementSibling && input.nextElementSibling.classList.contains('error-message')) {
                    input.nextElementSibling.classList.add('show');
                }
                isValid = false;
            } else {
                input.classList.remove('input-error');
                if (input.nextElementSibling && input.nextElementSibling.classList.contains('error-message')) {
                    input.nextElementSibling.classList.remove('show');
                }
            }
        });

        return isValid;
    }

    // Handle form submission
    async function handleSubmitPayment(e) {
        e.preventDefault();
        
        if (!validateForm()) {
            return;
        }

        const submitBtn = document.getElementById('submitPayment');
        
        // Show loading state
        submitBtn.classList.add('loading');
        submitBtn.disabled = true;

        // Get order data
        const orderData = {
            items: cartItems,
            customer: {
                email: document.getElementById('email').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                phone: document.getElementById('phone').value,
            },
            billing: {
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                zip: document.getElementById('zip').value,
                country: document.getElementById('country').value,
            },
            totals: {
                subtotal: parseFloat(document.getElementById('subtotal').textContent.replace('$', '')),
                tax: parseFloat(document.getElementById('tax').textContent.replace('$', '')),
                total: parseFloat(document.getElementById('total').textContent.replace('$', '')),
            }
        };

        // Simulate payment processing (replace with actual Stripe payment intent)
        setTimeout(() => {
            // Generate order number
            const orderNumber = 'CYA-' + new Date().getFullYear() + '-' + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            document.getElementById('orderNumber').textContent = orderNumber;
            
            // Store order data
            sessionStorage.setItem('lastOrder', JSON.stringify({
                orderNumber: orderNumber,
                ...orderData
            }));
            
            // Clear cart
            sessionStorage.removeItem('cartItems');
            sessionStorage.removeItem('appliedPromo');
            
            // Show success message
            document.getElementById('successOverlay').classList.add('show');
            
            // Reset button
            submitBtn.classList.remove('loading');
            submitBtn.disabled = false;
            
            // Redirect after 3 seconds
            setTimeout(() => {
                window.location.href = 'order-confirmation.html';
            }, 3000);
        }, 2000);
    }

    // Close success overlay when clicked outside
    document.getElementById('successOverlay').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('show');
        }
    });

    // Input formatting for phone number
    document.getElementById('phone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 0) {
            if (value.length <= 3) {
                value = `(${value}`;
            } else if (value.length <= 6) {
                value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
            } else {
                value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
            }
        }
        e.target.value = value;
    });

    // Initialize checkout on page load
    document.addEventListener('DOMContentLoaded', initCheckout);

    /* 
    ===============================
    STRIPE INTEGRATION INSTRUCTIONS
    ===============================
    
    1. Include Stripe.js (already included above)
    
    2. Initialize Stripe with your publishable key:
       const stripe = Stripe('pk_test_YOUR_KEY_HERE');
    
    3. Create Elements instance:
       const elements = stripe.elements();
    
    4. Create and mount card element:
       const cardElement = elements.create('card', {
           style: {
               base: {
                   fontSize: '16px',
                   color: '#333',
                   '::placeholder': {
                       color: '#aab7c4',
                   },
               },
           },
       });
       cardElement.mount('#card-element');
    
    5. Handle form submission:
       - Create payment intent on your server
       - Confirm payment with Stripe
       - Handle success/error responses
    
    6. Backend requirements:
       - Server endpoint to create payment intent
       - Webhook handler for payment events
       - Order processing logic
    */
</script>
