<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - CY visa help</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #0a2342;
            --accent-color: #d4af37;
            --light-bg: #f9f9f9;
            --white: #ffffff;
            --text-dark: #333333;
            --text-light: #666666;
            --success-color: #28a745;
            --error-color: #dc3545;
        }

        body {
            font-family: 'Roboto', sans-serif;
            color: var(--text-dark);
            line-height: 1.6;
            background: var(--light-bg);
        }

        /* Header Styles */
        header {
            background: var(--white);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
            letter-spacing: 1px;
        }

        .logo span {
            color: var(--accent-color);
        }

        .checkout-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--text-light);
        }

        .checkout-indicator i {
            color: var(--accent-color);
        }

        /* Progress Bar */
        .progress-bar {
            background: var(--white);
            padding: 2rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .progress-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            position: relative;
        }

        .progress-step {
            text-align: center;
            flex: 1;
            position: relative;
        }

        .progress-step::before {
            content: '';
            position: absolute;
            top: 15px;
            left: -50%;
            right: 50%;
            height: 2px;
            background: #e0e0e0;
            z-index: -1;
        }

        .progress-step:first-child::before {
            display: none;
        }

        .progress-step.completed::before {
            background: var(--accent-color);
        }

        .step-circle {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e0e0e0;
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 0.5rem;
            font-weight: 500;
        }

        .progress-step.active .step-circle,
        .progress-step.completed .step-circle {
            background: var(--accent-color);
        }

        .step-label {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .progress-step.active .step-label {
            color: var(--primary-color);
            font-weight: 500;
        }

        /* Main Checkout Container */
        .checkout-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 3rem;
        }

        /* Left Column - Forms */
        .checkout-forms {
            background: var(--white);
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-bg);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-weight: 500;
        }

        .required {
            color: var(--error-color);
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        select {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .input-error {
            border-color: var(--error-color);
        }

        .error-message {
            color: var(--error-color);
            font-size: 0.85rem;
            margin-top: 0.3rem;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Payment Section */
        .payment-methods {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .payment-method {
            flex: 1;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }

        .payment-method.selected {
            border-color: var(--accent-color);
            background: rgba(212, 175, 55, 0.05);
        }

        .payment-method i {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        /* Stripe Elements Container */
        #card-element {
            padding: 0.8rem 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: var(--white);
            min-height: 50px;
        }

        .card-errors {
            color: var(--error-color);
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        /* Security Badge */
        .security-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            padding: 0.8rem;
            background: rgba(40, 167, 69, 0.05);
            border-radius: 5px;
            color: var(--success-color);
            font-size: 0.9rem;
        }

        /* Right Column - Order Summary */
        .order-summary {
            position: sticky;
            top: 100px;
            height: fit-content;
        }

        .summary-card {
            background: var(--white);
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .summary-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
        }

        .cart-items {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
            padding: 1rem;
            background: var(--light-bg);
            border-radius: 8px;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: 500;
            color: var(--primary-color);
            margin-bottom: 0.3rem;
        }

        .item-type {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .item-price {
            font-weight: 500;
            color: var(--accent-color);
        }

        .remove-item {
            color: var(--text-light);
            cursor: pointer;
            margin-left: 1rem;
            transition: color 0.3s ease;
        }

        .remove-item:hover {
            color: var(--error-color);
        }

        /* Promo Code */
        .promo-code {
            margin: 1.5rem 0;
        }

        .promo-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .promo-input-group input {
            flex: 1;
        }

        .btn-apply {
            padding: 0.8rem 1.5rem;
            background: var(--primary-color);
            color: var(--white);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-apply:hover {
            background: #0d3a66;
        }

        /* Summary Totals */
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.8rem;
        }

        .summary-row.total {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--primary-color);
            padding-top: 1rem;
            border-top: 2px solid var(--light-bg);
            margin-top: 1rem;
        }

        .discount-row {
            color: var(--success-color);
        }

        /* Checkout Button */
        .btn-checkout {
            width: 100%;
            padding: 1.2rem;
            background: var(--accent-color);
            color: var(--white);
            border: none;
            border-radius: 5px;
            font-size: 1.1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-checkout:hover {
            background: #c4a137;
            transform: translateY(-2px);
        }

        .btn-checkout:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid var(--white);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .btn-checkout.loading .spinner {
            display: inline-block;
        }

        .btn-checkout.loading .btn-text {
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Trust Badges */
        .trust-badges {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e0e0e0;
        }

        .trust-badge {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            color: var(--text-light);
            font-size: 0.85rem;
        }

        /* Success Message */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .success-overlay.show {
            display: flex;
        }

        .success-modal {
            background: var(--white);
            border-radius: 10px;
            padding: 3rem;
            text-align: center;
            max-width: 500px;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .success-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--success-color);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 1.5rem;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .checkout-container {
                grid-template-columns: 1fr;
            }

            .order-summary {
                position: static;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .payment-methods {
                flex-direction: column;
            }

            .progress-step .step-label {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-container">
            <a href="index.html" class="logo">CY <span>visa</span> help</a>
            <div class="checkout-indicator">
                <i class="fas fa-lock"></i>
                <span>Secure Checkout</span>
            </div>
        </div>
    </header>

    <!-- Progress Bar -->
    <div class="progress-bar">
        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-step completed">
                    <div class="step-circle">1</div>
                    <div class="step-label">Cart</div>
                </div>
                <div class="progress-step active">
                    <div class="step-circle">2</div>
                    <div class="step-label">Information</div>
                </div>
                <div class="progress-step">
                    <div class="step-circle">3</div>
                    <div class="step-label">Payment</div>
                </div>
                <div class="progress-step">
                    <div class="step-circle">4</div>
                    <div class="step-label">Confirmation</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Checkout Container -->
    <div class="checkout-container">
        <!-- Left Column - Forms -->
        <div class="checkout-forms">
            <!-- Customer Information -->
            <section class="customer-info">
                <h2 class="section-title">Customer Information</h2>
                <form id="checkoutForm">
                    <div class="form-group">
                        <label for="email">Email Address <span class="required">*</span></label>
                        <input type="email" id="email" name="email" required>
                        <span class="error-message">Please enter a valid email address</span>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">First Name <span class="required">*</span></label>
                            <input type="text" id="firstName" name="firstName" required>
                            <span class="error-message">First name is required</span>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name <span class="required">*</span></label>
                            <input type="text" id="lastName" name="lastName" required>
                            <span class="error-message">Last name is required</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="phone">Phone Number</label>
                        <input type="tel" id="phone" name="phone">
                    </div>
                </form>
            </section>

            <!-- Billing Information -->
            <section class="billing-info">
                <h2 class="section-title">Billing Information</h2>
                <div class="form-group">
                    <label for="address">Street Address <span class="required">*</span></label>
                    <input type="text" id="address" name="address" required>
                    <span class="error-message">Address is required</span>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="city">City <span class="required">*</span></label>
                        <input type="text" id="city" name="city" required>
                        <span class="error-message">City is required</span>
                    </div>
                    <div class="form-group">
                        <label for="state">State / Province</label>
                        <input type="text" id="state" name="state">
                        <span class="error-message">State / Province is required (for US/CA)</span>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="zip">ZIP / Postal Code <span class="required">*</span></label>
                        <input type="text" id="zip" name="zip" required>
                        <span class="error-message">ZIP / Postal code is required</span>
                    </div>
                    <div class="form-group">
                        <label for="country">Country <span class="required">*</span></label>
                        <select id="country" name="country" required>
                            <option value="">Select Country</option>
                            <option value="US" selected>United States</option>
                            <option value="CA">Canada</option>
                            <option value="MX">Mexico</option>
                            <option value="GB">United Kingdom</option>
                            <option value="AU">Australia</option>
                            <option value="DE">Germany</option>
                            <option value="FR">France</option>
                            <option value="OTHER">Other / International</option> 
                        </select>
                        <span class="error-message">Please select a country</span>
                    </div>
                </div>
            </section>

            <!-- Payment Information -->
            <section class="payment-info">
                <h2 class="section-title">Payment Method</h2>
                
                <div class="payment-methods">
                    <div class="payment-method selected" data-method="card">
                        <i class="fas fa-credit-card"></i>
                        <div>Credit/Debit Card</div>
                    </div>
                    <div class="payment-method" data-method="paypal">
                        <i class="fab fa-paypal"></i>
                        <div>PayPal</div>
                    </div>
                </div>

                <!-- Stripe Card Element Container -->
                <div id="card-payment" class="payment-form">
                    <div class="form-group">
                        <label for="card-element">Card Details <span class="required">*</span></label>
                        <div id="card-element">
                            <!-- Stripe Elements will be inserted here by JavaScript -->
                        </div>
                        <div id="card-errors" class="card-errors" role="alert"></div>
                    </div>

                    <div class="security-badge">
                        <i class="fas fa-shield-alt"></i>
                        <span>Your payment information is encrypted and secure</span>
                    </div>
                </div>

                <!-- PayPal Payment Option (Hidden by default) -->
                <div id="paypal-payment" class="payment-form" style="display: none;">
                    <p>You will be redirected to PayPal to complete your payment.</p>
                </div>
            </section>
        </div>

        <!-- Right Column - Order Summary -->
        <div class="order-summary">
            <div class="summary-card">
                <h2 class="summary-title">Order Summary</h2>
                
                <div class="cart-items" id="cartItems">
                    <!-- Cart items will be dynamically added here -->
                    <div class="cart-item">
                        <div class="item-details">
                            <div class="item-name">EB-2 NIW Visa Strategy Webinar</div>
                            <div class="item-type">Recorded Webinar</div>
                        </div>
                        <div class="item-price">$149.99</div>
                        <i class="fas fa-times remove-item" data-item-id="1"></i>
                    </div>
                </div>

                <!-- Promo Code -->
                <div class="promo-code">
                    <div class="promo-input-group">
                        <input type="text" id="promoCode" placeholder="Enter promo code">
                        <button class="btn-apply">Apply</button>
                    </div>
                </div>

                <!-- Summary Totals -->
                <div class="summary-totals">
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span id="subtotal">$149.99</span>
                    </div>
                    <div class="summary-row discount-row" id="discountRow" style="display: none;">
                        <span>Discount</span>
                        <span id="discount">-$0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>Tax</span>
                        <span id="tax">$13.50</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span id="total">$163.49</span>
                    </div>
                </div>

                <!-- Checkout Button -->
                <button class="btn-checkout" id="submitPayment">
                    <span class="btn-text">Complete Purchase</span>
                    <div class="spinner"></div>
                </button>

                <!-- Trust Badges -->
                <div class="trust-badges">
                    <div class="trust-badge">
                        <i class="fas fa-lock"></i>
                        <span>Secure</span>
                    </div>
                    <div class="trust-badge">
                        <i class="fas fa-shield-alt"></i>
                        <span>Protected</span>
                    </div>
                    <div class="trust-badge">
                        <i class="fab fa-stripe"></i>
                        <span>Stripe</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Overlay -->
    <div class="success-overlay" id="successOverlay">
        <div class="success-modal">
            <div class="success-icon">
                <i class="fas fa-check"></i>
            </div>
            <h2 style="font-family: 'Playfair Display', serif; color: var(--primary-color); margin-bottom: 1rem;">
                Order Confirmed!
            </h2>
            <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                Thank you for your purchase. You will receive a confirmation email shortly with your order details and download links.
            </p>
            <p style="font-weight: 500; color: var(--text-dark);">
                Order #: <span id="orderNumber">CVH-2024-0001</span>
            </p>
        </div>
    </div>

    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <script>
    // ===============================================
    // *** STRIPE INITIALIZATION AND HANDLING LOGIC ***
    // ===============================================
    
    // NOTE: REPLACE with your actual publishable key from Stripe Dashboard
    const STRIPE_PUBLISHABLE_KEY = 'pk_test_TYSSgR5vK8fWj8bO3E5uVlMv'; // Example test key (must be replaced)
    
    const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
    const elements = stripe.elements({
        fonts: [{ cssSrc: 'https://fonts.googleapis.com/css2?family=Roboto:wght@400&display=swap' }]
    });

    const cardElement = elements.create('card', {
        style: {
            base: {
                fontSize: '16px',
                color: '#333',
                '::placeholder': {
                    color: '#aab7c4',
                },
                fontFamily: 'Roboto, sans-serif'
            },
            invalid: {
                color: 'var(--error-color)',
                iconColor: 'var(--error-color)'
            }
        }
    });

    // Mount the Card Element to the DOM
    document.addEventListener('DOMContentLoaded', () => {
        if (document.getElementById('card-element')) {
            cardElement.mount('#card-element');
        }
    });

    // Handle real-time validation errors from the card Element.
    cardElement.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });

    // ===============================================
    // *** PAYMENT SUBMISSION FUNCTION (UPDATED) ***
    // ===============================================

    async function processStripePayment(totalAmount) {
        const displayError = document.getElementById('card-errors');
        displayError.textContent = ''; // Clear previous errors
        
        // 1. Fetch the client_secret from your Netlify Function
        const response = await fetch('/.netlify/functions/create-payment-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                amount: totalAmount,
            })
        });

        if (!response.ok) {
            // CRITICAL CHECK: If the serverless function call failed (e.g., 404, 500 from missing key)
            let errorData = { message: `Payment initialization failed. Server status: ${response.status}` };
            
            try {
                // Try to parse the error message if the server sent JSON
                const serverResponse = await response.json();
                errorData.message = serverResponse.error || errorData.message;
            } catch (e) {
                // If the server didn't send JSON (e.g., a simple HTML 500 page), use the default message
            }

            displayError.textContent = errorData.message + ' (Check Netlify logs and STRIPE_SECRET_KEY)';
            return { success: false, error: errorData };
        }
        
        const { clientSecret, error: serverError } = await response.json();

        if (serverError || !clientSecret) {
            // If the server returned a 200 but included an explicit error or missing secret
            displayError.textContent = serverError.message || 'Failed to receive payment details from server.';
            return { success: false, error: serverError };
        }

        // 2. Confirm payment with Stripe using the received clientSecret
        const billingDetails = {
            name: document.getElementById('firstName').value + ' ' + document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            address: {
                line1: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                postal_code: document.getElementById('zip').value,
                country: document.getElementById('country').value,
            }
        };

        const { paymentIntent, error: confirmError } = await stripe.confirmCardPayment(
            clientSecret, {
                payment_method: {
                    card: cardElement,
                    billing_details: billingDetails,
                }
            }
        );

        if (confirmError) {
            // Show error to your customer (e.g., incorrect CVC, card declined)
            displayError.textContent = confirmError.message;
            return { success: false, error: confirmError };
        } else if (paymentIntent.status === 'succeeded') {
            // The payment succeeded!
            return { success: true, paymentIntent };
        } else {
             // This is typically for 'requires_action' or other intermediate statuses
            return { success: false, error: { message: `Payment status: ${paymentIntent.status}` } };
        }
    }

    // ===============================================
    // *** EXISTING CART/FORM/LOGIC FUNCTIONS ***
    // ===============================================

    const SESSION_STORAGE_CART_KEY = 'cartItems';
    const SESSION_STORAGE_PROMO_KEY = 'appliedPromo';
    const SESSION_STORAGE_ORDER_KEY = 'lastOrder';

    let cartItems = JSON.parse(sessionStorage.getItem(SESSION_STORAGE_CART_KEY));

    function initCheckout() {
        if (!cartItems || cartItems.length === 0) {
            const defaultCart = [{
                id: 1,
                name: 'EB-2 NIW Visa Strategy Webinar',
                price: 149.99,
                quantity: 1
            }];
            sessionStorage.setItem(SESSION_STORAGE_CART_KEY, JSON.stringify(defaultCart));
            cartItems = defaultCart;
            console.warn('No cart found in sessionStorage. Loading demo cart for testing.');
        }
        
        displayCartItems();
        updateTotals();
        attachEventListeners();
    }

    function displayCartItems() {
        const cartItemsContainer = document.getElementById('cartItems');
        cartItemsContainer.innerHTML = '';
        
        cartItems.forEach(item => {
            const cartItemHTML = `
                <div class="cart-item" data-item-id="${item.id}">
                    <div class="item-details">
                        <div class="item-name">${item.name}</div>
                        <div class="item-type">Quantity: ${item.quantity}</div>
                    </div>
                    <div class="item-price">$${(item.price * item.quantity).toFixed(2)}</div>
                    <i class="fas fa-times remove-item" data-item-id="${item.id}"></i>
                </div>
            `;
            cartItemsContainer.insertAdjacentHTML('beforeend', cartItemHTML);
        });
        
        document.querySelectorAll('.remove-item').forEach(btn => {
            btn.addEventListener('click', handleRemoveItem);
        });
    }

    function updateTotals() {
        const subtotal = cartItems.reduce((total, item) => total + (item.price * item.quantity), 0);
        const discountAmount = getDiscountAmount(subtotal);
        const taxableAmount = subtotal - discountAmount;
        const tax = taxableAmount * 0.09; // 9% tax rate
        const total = taxableAmount + tax;
        
        document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('tax').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        
        const discountRow = document.getElementById('discountRow');
        const discountText = document.getElementById('discount');

        if (discountAmount > 0) {
            discountRow.style.display = 'flex';
            discountText.textContent = `-$${discountAmount.toFixed(2)}`;
            
            const appliedPromo = sessionStorage.getItem(SESSION_STORAGE_PROMO_KEY);
            if (appliedPromo) {
                const promoInput = document.getElementById('promoCode');
                promoInput.value = promoInput.value || appliedPromo;
                promoInput.style.borderColor = 'var(--success-color)';
                promoInput.disabled = true;
                document.querySelector('.btn-apply').textContent = 'Applied!';
                document.querySelector('.btn-apply').style.background = 'var(--success-color)';
            }
        } else {
            discountRow.style.display = 'none';
        }
        return total;
    }

    function getDiscountAmount(subtotal) {
        const appliedPromo = sessionStorage.getItem(SESSION_STORAGE_PROMO_KEY);
        if (appliedPromo === 'SAVE10' || appliedPromo === 'VISA10') {
            return subtotal * 0.1;
        }
        return 0;
    }

    function handleRemoveItem(e) {
        const itemId = parseInt(e.currentTarget.dataset.itemId);
        cartItems = cartItems.filter(item => item.id !== itemId);
        sessionStorage.setItem(SESSION_STORAGE_CART_KEY, JSON.stringify(cartItems));
        
        if (cartItems.length === 0) {
            sessionStorage.removeItem(SESSION_STORAGE_PROMO_KEY);
            alert('Your cart is empty. Redirecting to shop...');
            // window.location.href = 'shop.html';
        } else {
            displayCartItems();
            updateTotals(); 
        }
    }

    const paymentMethods = document.querySelectorAll('.payment-method');
    const cardPayment = document.getElementById('card-payment');
    const paypalPayment = document.getElementById('paypal-payment');

    function attachEventListeners() {
        paymentMethods.forEach(method => {
            method.addEventListener('click', () => {
                paymentMethods.forEach(m => m.classList.remove('selected'));
                method.classList.add('selected');
                
                if (method.dataset.method === 'card') {
                    cardPayment.style.display = 'block';
                    paypalPayment.style.display = 'none';
                } else {
                    cardPayment.style.display = 'none';
                    paypalPayment.style.display = 'block';
                }
            });
        });

        document.querySelector('.btn-apply').addEventListener('click', handlePromoCode);
        document.getElementById('submitPayment').addEventListener('click', handleSubmitPayment);
    }

    function handlePromoCode() {
        const promoCodeInput = document.getElementById('promoCode');
        const promoCode = promoCodeInput.value.trim().toUpperCase();
        const applyBtn = document.querySelector('.btn-apply');
        
        if (promoCode === 'SAVE10' || promoCode === 'VISA10') {
            sessionStorage.setItem(SESSION_STORAGE_PROMO_KEY, promoCode);
            updateTotals();
            
            promoCodeInput.style.borderColor = 'var(--success-color)';
            promoCodeInput.disabled = true;
            applyBtn.textContent = 'Applied!';
            applyBtn.style.background = 'var(--success-color)';
        } else {
            sessionStorage.removeItem(SESSION_STORAGE_PROMO_KEY);
            updateTotals();
            alert('Invalid promo code');
            promoCodeInput.style.borderColor = 'var(--error-color)';
        }
    }

    const form = document.getElementById('checkoutForm');

    function validateForm() {
        const requiredInputs = form.querySelectorAll('input[required], select[required]');
        let isValid = true;

        requiredInputs.forEach(input => {
            if (!input.value) {
                input.classList.add('input-error');
                const errorMessage = input.nextElementSibling;
                if (errorMessage && errorMessage.classList.contains('error-message')) {
                    errorMessage.classList.add('show');
                }
                isValid = false;
            } else {
                input.classList.remove('input-error');
                const errorMessage = input.nextElementSibling;
                if (errorMessage && errorMessage.classList.contains('error-message')) {
                    errorMessage.classList.remove('show');
                }
            }
        });
        
        // Custom check for email format
        const emailInput = document.getElementById('email');
        if (emailInput.value && !/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/.test(emailInput.value)) {
            emailInput.classList.add('input-error');
            emailInput.nextElementSibling.classList.add('show');
            isValid = false;
        }

        return isValid;
    }

    // Main submit handler
    async function handleSubmitPayment(e) {
        e.preventDefault();
        
        if (!validateForm()) {
            const firstError = document.querySelector('.input-error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return;
        }

        const submitBtn = document.getElementById('submitPayment');
        submitBtn.classList.add('loading');
        submitBtn.disabled = true;

        const selectedMethod = document.querySelector('.payment-method.selected').dataset.method;
        let paymentResult = { success: false };
        const totalAmount = updateTotals(); // Get the calculated total

        if (selectedMethod === 'card') {
            // Initiate Stripe payment confirmation via Netlify Function call
            paymentResult = await processStripePayment(totalAmount);
        } else if (selectedMethod === 'paypal') {
            // PayPal simulation
            console.log("Simulating PayPal redirect...");
            await new Promise(resolve => setTimeout(resolve, 2000));
            paymentResult.success = true;
        }


        if (paymentResult.success) {
            // Logic for a successful payment
            const orderNumber = 'CVH-' + new Date().getFullYear() + '-' + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            document.getElementById('orderNumber').textContent = orderNumber;
            
            // Collect and store order data (simplified)
            const orderData = { orderNumber, totals: { total: totalAmount } };
            sessionStorage.setItem(SESSION_STORAGE_ORDER_KEY, JSON.stringify(orderData));
            
            sessionStorage.removeItem(SESSION_STORAGE_CART_KEY);
            sessionStorage.removeItem(SESSION_STORAGE_PROMO_KEY);
            
            document.getElementById('successOverlay').classList.add('show');
            
            submitBtn.classList.remove('loading');
            submitBtn.disabled = false;
            
            setTimeout(() => {
                // window.location.href = 'order-confirmation.html';
            }, 3000);
        } else {
            // Handle Payment Failure
            alert(`Payment Failed: ${paymentResult.error ? paymentResult.error.message : 'Unknown error'}`);
            submitBtn.classList.remove('loading');
            submitBtn.disabled = false;
        }
    }

    document.getElementById('successOverlay').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('show');
        }
    });

    document.getElementById('phone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 0) {
            if (value.length <= 3) {
                value = `(${value}`;
            } else if (value.length <= 6) {
                value = `(${value.slice(0, 3)}) ${value.slice(3)}`;
            } else {
                value = `(${value.slice(0, 3)}) ${value.slice(3, 6)}-${value.slice(6, 10)}`;
            }
        }
        e.target.value = value;
    });

    document.addEventListener('DOMContentLoaded', initCheckout);
    </script>
</body>
</html>
